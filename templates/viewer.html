{% extends "base.html" %}

{% block navbar_extra %}
<a href="javascript:void(0);" onclick="showDownloadForm()" class="btn btn-outline" style="margin-right: 0.5rem;">
    Descargar
</a>
{% endblock %}
{% block content %}
<style>
    .pdf-page {
        display: block;
        max-width: 100%;
        height: auto;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    /* Fullscreen overrides */
    :fullscreen,
    ::backdrop {
        background-color: #525659;
        width: 100% !important;
        height: 100% !important;
        max-width: none !important;
        margin: 0 !important;
        border-radius: 0 !important;
        display: flex;
        flex-direction: column;
    }

    /* Safari support */
    :-webkit-full-screen {
        background-color: #525659;
        width: 100% !important;
        height: 100% !important;
        max-width: none !important;
        margin: 0 !important;
        border-radius: 0 !important;
        display: flex;
        flex-direction: column;
    }

    :fullscreen #pdf-container,
    :-webkit-full-screen #pdf-container {
        height: auto !important;
        flex: 1;
    }
</style>

<div style="max-width: 1000px; margin: 0 auto; text-align: center;">
    <div style="display: flex; justify-content: center; align-items: baseline; gap: 1rem; margin-bottom: 0.5rem;">
        <h2 style="margin: 0; font-weight: normal;">{{ pdf.title }}</h2>
    </div>

    <!-- Custom PDF.js Viewer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <!-- Unified Viewer Card -->
    <div
        style="max-width: 500px; margin: 2rem auto; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);">

        <!-- PDF Container -->
        <div id="pdf-container"
            style="width: 100%; height: 500px; overflow-y: auto; background: #525659; padding: 2rem 0; display: flex; flex-direction: column; align-items: center;"
            oncontextmenu="return false;">
            <p id="loading-text" style="color: white; text-align: center; margin-top: 2rem;">Cargando documento...</p>
        </div>

        <!-- Controls Toolbar -->
        <div
            style="background: #2c3e50; color: white; padding: 0.5rem; display: flex; gap: 0.5rem; justify-content: center; align-items: center; border-top: 1px solid #34495e; flex-wrap: wrap;">

            <!-- Zoom Controls -->
            <button onclick="changeZoom(-0.12)" class="btn btn-outline"
                style="color: white; border-color: rgba(255,255,255,0.3); padding: 4px 8px; font-weight: bold; min-width: 32px;"
                title="Reducir">-</button>
            <span id="zoom-level"
                style="font-family: monospace; font-size: 0.9rem; min-width: 50px; text-align: center;">100%</span>
            <button onclick="changeZoom(0.12)" class="btn btn-outline"
                style="color: white; border-color: rgba(255,255,255,0.3); padding: 4px 8px; font-weight: bold; min-width: 32px;"
                title="Ampliar">+</button>

            <div style="width: 1px; height: 20px; background: rgba(255,255,255,0.2); margin: 0 0.2rem;"></div>

            <!-- Page Indicator -->
            <span id="page-indicator"
                style="font-family: monospace; font-size: 0.9rem; min-width: 60px; text-align: center;">-- / --</span>

            <div style="width: 1px; height: 20px; background: rgba(255,255,255,0.2); margin: 0 0.2rem;"></div>

            <!-- Double Page Toggle -->
            <button onclick="toggleDoublePage()" id="btn-double" class="btn btn-outline"
                style="color: white; border-color: rgba(255,255,255,0.3); padding: 6px; display: flex; align-items: center;"
                title="Doble Página">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
            </button>

            <!-- Fullscreen -->
            <button onclick="toggleFullscreen()" id="btn-fullscreen" class="btn btn-outline"
                style="color: white; border-color: rgba(255,255,255,0.3); padding: 6px; display: flex; align-items: center;"
                title="Pantalla Completa">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" />
                </svg>
            </button>
        </div>
    </div>




</div>

<script>
    const url = '/pdf/{{ pdf.id }}/inline';
    const container = document.getElementById('pdf-container');
    const loadingText = document.getElementById('loading-text');
    const zoomLevelDisplay = document.getElementById('zoom-level');
    const pageIndicator = document.getElementById('page-indicator');
    const btnDouble = document.getElementById('btn-double');

    let pdfDoc = null;
    let currentScale = 0.6;
    let isRendering = false;
    let isDoublePage = false;
    let pageObserver = null;
    let currentVisiblePage = 1;

    function initPageObserver() {
        if (pageObserver) pageObserver.disconnect();

        const options = {
            root: container,
            rootMargin: '0px',
            threshold: 0.1
        };

        pageObserver = new IntersectionObserver((entries) => {
            const visiblePages = entries
                .filter(entry => entry.isIntersecting)
                .map(entry => parseInt(entry.target.dataset.pageNumber))
                .sort((a, b) => a - b);

            if (visiblePages.length > 0) {
                currentVisiblePage = visiblePages[0];
                const totalPages = pdfDoc ? pdfDoc.numPages : '--';
                if (pageIndicator) pageIndicator.textContent = `${currentVisiblePage} / ${totalPages}`;
            }
        }, options);
    }

    async function renderPageToCanvas(pageNum, scale) {
        const page = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale: scale });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        canvas.className = 'pdf-page';
        canvas.dataset.pageNumber = pageNum;

        const renderContext = {
            canvasContext: context,
            viewport: viewport
        };
        await page.render(renderContext).promise;
        return canvas;
    }

    async function renderPDF(scale) {
        if (!pdfDoc) return;
        isRendering = true;

        // Save target page before any changes
        const targetPage = currentVisiblePage;

        currentScale = scale;
        const BASE_SCALE = 0.6;
        if (zoomLevelDisplay) {
            const percentage = Math.round((currentScale / BASE_SCALE) * 100);
            zoomLevelDisplay.textContent = `${percentage}%`;
        }

        // BUFFERING: Render to off-screen fragment
        const fragment = document.createDocumentFragment();

        if (isDoublePage) {
            // COVER
            if (pdfDoc.numPages >= 1) {
                const cover = await renderPageToCanvas(1, scale);
                fragment.appendChild(cover);
            }

            // PAIRS
            for (let pageNum = 2; pageNum <= pdfDoc.numPages; pageNum += 2) {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'center';
                row.style.gap = '20px';
                row.style.marginBottom = '20px';
                row.style.width = '100%';

                const canvas1 = await renderPageToCanvas(pageNum, scale);
                canvas1.style.marginBottom = '0';
                row.appendChild(canvas1);

                if (pageNum + 1 <= pdfDoc.numPages) {
                    const canvas2 = await renderPageToCanvas(pageNum + 1, scale);
                    canvas2.style.marginBottom = '0';
                    row.appendChild(canvas2);
                }
                fragment.appendChild(row);
            }
        } else {
            // SINGLE
            for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                const canvas = await renderPageToCanvas(pageNum, scale);
                fragment.appendChild(canvas);
            }
        }

        // SWAP CONTENT AT ONCE (Prevents "Jump to Top")
        container.innerHTML = '';
        container.appendChild(fragment);

        // RE-ATTACH OBSERVERS
        initPageObserver();
        const allCanvases = container.querySelectorAll('canvas.pdf-page');
        allCanvases.forEach(canvas => pageObserver.observe(canvas));

        // RESTORE SCROLL
        const targetElement = container.querySelector(`canvas[data-page-number="${targetPage}"]`);
        if (targetElement) {
            targetElement.scrollIntoView({ block: 'start' });
        }

        isRendering = false;
    }

    async function initPDF() {
        try {
            const loadingTask = pdfjsLib.getDocument(url);
            pdfDoc = await loadingTask.promise;
            if (loadingText) loadingText.remove();

            renderPDF(currentScale);
        } catch (error) {
            console.error('Error loading PDF:', error);
            container.innerHTML = '<p style="color: white;">Error al cargar el documento.</p>';
        }
    }

    function changeZoom(delta) {
        if (isRendering) return;
        const newScale = currentScale + delta;
        if (newScale >= 0.25 && newScale <= 3.0) {
            renderPDF(newScale);
        }
    }

    function toggleDoublePage() {
        if (isRendering) return;
        isDoublePage = !isDoublePage;

        const singlePageIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>`;
        const doublePageIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>`;

        if (isDoublePage) {
            btnDouble.innerHTML = singlePageIcon;
            btnDouble.title = "Vista Página Simple";
        } else {
            btnDouble.innerHTML = doublePageIcon;
            btnDouble.title = "Vista Doble Página";
        }
        renderPDF(currentScale);
    }

    function toggleFullscreen() {
        const wrapper = container.parentElement;
        if (!document.fullscreenElement) {
            wrapper.requestFullscreen().catch(err => {
                alert(`Error al entrar en pantalla completa: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    }

    function showDownloadForm() {
        const code = prompt("Introduce el Código de Acceso:");
        if (code) {
            downloadFileConfirm(code);
        }
    }

    // Fullscreen Event Listener
    document.addEventListener('fullscreenchange', () => {
        const btnFullscreen = document.getElementById('btn-fullscreen');
        const expandIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>`;
        const compressIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>`;

        if (document.fullscreenElement) {
            btnFullscreen.innerHTML = compressIcon;
            btnFullscreen.title = "Salir de Pantalla Completa";
        } else {
            btnFullscreen.innerHTML = expandIcon;
            btnFullscreen.title = "Pantalla Completa";
        }
    });

    initPDF();

    async function downloadFileConfirm(code) {
        if (!code) return;

        const formData = new FormData();
        formData.append('access_code', code);

        try {
            const response = await fetch('/pdf/{{ pdf.id }}/download', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "{{ pdf.filename }}";
                document.body.appendChild(a);
                a.click();
                a.remove();
            } else {
                const err = await response.json();
                alert(err.detail || "Código incorrecto.");
            }
        } catch (e) {
            alert("Error de conexión.");
        }
    }
</script>
{% endblock %}